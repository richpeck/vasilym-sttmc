#########################################
#########################################

## RPECK 31/10/2022 - Statamic Push    ##

#########################################
#########################################

## Name ##
name: Push Statamic To Production Server

## Triggers ##
on:
  push:
    branches: ["master"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: 

# Jobs
jobs:

  # Push
  push:
  
    # Name
    name: Push with SCP
  
    # OS
    runs-on: ubuntu-latest
    
    # Steps
    steps:
    
      # Checkout Repo
      - uses: actions/checkout@v3
      
      # Upload SCP
      - name: Copy Files Via SCP
        uses: appleboy/scp-action@master
        with:
          host:             ${{ secrets.HOST }}
          username:         ${{ secrets.USERNAME }}
          port:             ${{ secrets.PORT }}
          key:              ${{ secrets.KEY }}
          passphrase:       ${{ secrets.PASSPHRASE }}
          target:           "${{ secrets.TARGET }},!.git/**/*,!.github/**/*"
          source:           ${{ github.workspace }}
          overwrite:        true
          strip_components: 2
          
      # Reload NGinx
      - name: Reload NGinx
        uses: appleboy/ssh-action@master
        with:
          host:       ${{ secrets.HOST }}
          username:   ${{ secrets.USERNAME }}
          port:       ${{ secrets.PORT }}
          key:        ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          script: |
            cd ${{ secrets.TARGET }}
            composer update
            php artisan cache:clear
            sudo chmod -R 2777 storage
            sudo chmod -R 2777 vendor
            sudo chgrp -R www-data .
            composer dump-autoload
            sudo service nginx reload
